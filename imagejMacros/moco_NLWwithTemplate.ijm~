// ImageJ macro to apply moco plugin to stabilize input video.
// Assumes videos need to be cropped to 512 x 512. 
// Args:
//   path_denoised: string. path to tif containing denoised image stack
// Output:
//   Registered image stack at <path_denoised>_registered.tif
// Example usage (mac):
//   /Applications/Fiji.app/Contents/MacOS/ImageJ-macosx  -macro /Users/samueljyang/Dropbox/dump/fiji_macros/turboreg.ijm "/Users/samueljyang/Dropbox/dump/oeg/denoised_small.tif"

// Parse this command line argument
args = split(getArgument()," "); 
path_denoised =args[0];


// Set this path manually for debugging in ImageJ or FIJI
//  path_denoised="/Users/samueljyang/Dropbox/dump/oeg/denoised_small.tif";


// Load the denoised image stack
// open(path_denoised);

out_path = args[1];
print(out_path);

template_path = args[2];
print(template_path);

//run("Image Sequence...", "open="+path_denoised+" sort");
run("Image Sequence...", "open="+path_denoised+" file='.tif' sort");

makeRectangle(100, 0, 512, 512);
run("Crop");

//run("PureDenoise ", "parameters='3 1' estimation='Auto Global' ");
//rename("denoised");
//saveAs("Tiff", out_path+"/denoised.tif")

// batch mode is faster by not displaying images
setBatchMode(true); //It appears as if this has to come *after* the denoising...


////open(out_path+"/denoised.tif");

for(i=1; i<=nSlices;i++) {
	setSlice(i);
	setMetadata("Label",i-1);
}

rename("denoised");
run("8-bit");

Stack.getDimensions(width, height, channels, slices, frames); 


// Use the median image as the reference (target) image for alignment
/*
path_median= path_denoised +"_median.tif";
run("Z Project...", "start=1 stop=110 projection=Median");
*/
run("Image Sequence...", "open="+template_path+" file='.tif' sort");
run("Z Project...", "start=1 stop=1 projection=Median");
run("8-bit");
rename("median");


run("moco ", "value=102 downsample_value=1 template=median stack=denoised log=None plot=[No plot]");

rename("registered");
path_output = out_path+"/registered_noDenoise.tif";
saveAs("Tiff", path_output);


path_median= path_denoised +"_median.tif";
run("Z Project...", "start=1 stop=110 projection=Median");
rename("median");
path_output = out_path+"/median.tif";
saveAs("Tiff", path_output);


run("Quit");

/*
// Convert denoised image stack into individual frames
selectWindow("denoised");

run("Stack to Images");


// Run TurboReg to align each of the denoised frames to the reference frame
for(i=0;i < slices; i++) {
  print(i);
  window_median="median";
  window_denoised=i;
  run("TurboReg ", "-align -window "+window_denoised+" 0 0 511 511 -window "+window_median+" 0 0 511 511 -translation 256 256 256 256 -showOutput");
  run("Make Substack...", "  slices=1");
  close("Output*");
  rename(window_denoised+"_registered");
}
//setBatchMode(false); // TODO: figure out how to use these properly
//updateDisplay();

// Combine registered frames into an image stack
run("Images to Stack", "name=Stack title=[] use");
// The first ~half of the images are the input images; select only the registered images
run("Make Substack...", "  slices="+1+slices+1+"-"+2*slices+1);


// Save registered image stack as a single .tif file
rename("registered");
path_output = out_path+"/registered_noDenoise.tif";
saveAs("Tiff", path_output);


path_median= path_denoised +"_median.tif";
run("Z Project...", "start=1 stop=110 projection=Median");
rename("median");
path_output = out_path+"/median.tif";
saveAs("Tiff", path_output);


run("Quit");
*/